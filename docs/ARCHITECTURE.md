# Архитектура бота ОбучAI

## Общая схема

Все запросы проходят Блок 1. Шаблонные ответы (abuse/off_topic/cheat) тоже оцениваются Блоком 4 — проверяется только корректность определения типа. Кнопки обратной связи (Блок 5) показываются только для типа «вопрос по курсу».

```
┌─────────────────────────────────────────────────────────────┐
│                    Telegram Bot (bot.py)                     │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  Блок 1: Нормализация         │  (все запросы)
        │  type: question | abuse |     │
        │  off_topic | cheat            │
        └───────────┬───────────────────┘
                    │
        ┌───────────┴───────────┐
        │                       │
    question              abuse / off_topic / cheat
        │                       │
        ▼                       ▼
┌───────────────┐      ┌──────────────────────┐
│ Блок 2: RAG   │      │ Шаблонный ответ      │
│ (поиск чанков)│      │ (get_response_       │
└───────┬───────┘      │  template)            │
        │              └──────────┬────────────┘
        ▼                         │
┌───────────────┐                  │
│ Блок 3:       │                  │
│ Генерация     │                  │
│ (ответ по     │                  │
│  контексту)   │                  │
└───────┬───────┘                  │
        │                           │
        └───────────┬───────────────┘
                    │
                    ▼
        ┌───────────────────────────────┐
        │  Блок 4: Judge (скрыто)      │  оценивает ВСЕ запросы:
        │  - question: полная оценка   │  relevance, groundedness,
        │    (relevance, groundedness, │  safety, completeness,
        │     safety, completeness,     │  question_type_correct,
        │     question_type_correct)    │  correct_refusal
        │  - abuse/off_topic/cheat:    │  Если question_type_correct=0
        │    только корректность типа  │  или correct_refusal=0 →
        │    (question_type_correct)    │  остальные показатели = 0
        └───────────┬───────────────────┘
                    │
        ┌───────────┴───────────┐
        │                       │
    question              abuse/off_topic/cheat
        │                       │
        ▼                       ▼
┌───────────────┐      ┌──────────────────────┐
│ Блок 5:       │      │ Ответ без кнопок     │
│ Кнопки        │      │ (фидбэк не собираем) │
│ «Полезно» /   │      └──────────────────────┘
│ «Не помогло»  │
└───────────────┘
        │
        ▼ (при нажатии — обновление записи в логе по request_id)
┌───────────────┐
│ Лог фидбэка   │  запись создаётся при отправке ответа (request_id),
│ (обновление   │  обновляется при нажатии кнопки (rating)
│ по request_id)│
└───────────────┘
```

**Итог:** Судья проверяет все запросы (в т.ч. корректность определения abuse/off_topic/cheat). Пользователь видит кнопки только для ответов по курсу (type=question).

## Модули (корень проекта)

| Файл | Назначение |
|------|------------|
| `bot.py` | Точка входа, Telegram, связка блоков 1–5 |
| `config.py` | Конфигурация (пути, ключи, параметры RAG/LLM) |
| `gigachat_client.py` | Клиент GigaChat API |
| `block1_normalization.py` | Классификация и нормализация запроса |
| `block2_rag.py` | Загрузка документов, чанки, ChromaDB, поиск |
| `block3_generation.py` | Генерация ответа по контексту |
| `block4_judge.py` | LLM-Judge (оценка качества, скрыто) |
| `block5_feedback.py` | Логи обратной связи, эскалация куратору |
| `logs_to_sheets.py` | Дублирование логов в Google Таблицу (опционально) |

## Данные

- **knowledge_base/** — материалы курса (PDF, TXT, MD, DOCX)
- **vector_db/** — векторная БД ChromaDB (создаётся при запуске)
- **logs/** — feedback_log.json, judge_log.json, escalation_log.json

## Конфигурация

Переменные окружения (`.env`): `TELEGRAM_BOT_TOKEN`, `GIGACHAT_AUTH_KEY`, `CURATOR_CHAT_ID`. Остальное в `config.py`.

### Дублирование логов в Google Таблицу (реальное время)

Если заданы переменные:
- **GOOGLE_SHEET_ID** — ID таблицы из URL: `https://docs.google.com/spreadsheets/d/SHEET_ID/edit`
- **GOOGLE_CREDENTIALS_PATH** — путь к JSON-ключу сервисного аккаунта (Google Cloud Console → API и сервисы → Учётные данные → Создать ключ для сервисного аккаунта)

то события Judge, Feedback и Escalation дополнительно отправляются в три листа таблицы (**Judge**, **Feedback**, **Escalation**). Запись выполняется в фоновом потоке. Таблицу нужно открыть на редактирование для email сервисного аккаунта (из JSON).
